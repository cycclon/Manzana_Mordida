# Upstream definitions
upstream auth_backend {
    server ms-seguridad:3002;
}

upstream clientes_backend {
    server ms-clientes:3003;
}

upstream productos_backend {
    server ms-productos:3001;
}

# HTTP Server
server {
    listen 80;
    server_name 159.112.134.120;  # Replace with your IP like: 129.213.45.67

    # Health check
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Auth service
    location /auth/ {
        proxy_pass http://auth_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /users/ {
        proxy_pass http://auth_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Clientes service
    location /api/v1/clientes/ {
        proxy_pass http://clientes_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Productos service
    location /api/productos/ {
        proxy_pass http://productos_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api/equipos/ {
        proxy_pass http://productos_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

########## AUTH DOCUMENTATION ##########
location /docs/auth/ {
    proxy_pass http://auth_backend/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

########## CLIENTES DOCUMENTATION ##########
location /docs/clientes/ {
    proxy_pass http://clientes_backend/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

########## PRODUCTOS DOCUMENTATION ##########
location /docs/productos/ {
    proxy_pass http://productos_backend/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

############################################
# CLIENTES - swagger.json rewrite
############################################
location /docs/clientes/swagger.json {
    proxy_pass http://clientes_backend/swagger.json;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}

############################################
# PRODUCTOS - swagger.json rewrite
############################################
location /docs/productos/swagger.json {
    proxy_pass http://productos_backend/swagger.json;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}

############################################
# AUTH - swagger.json rewrite
############################################
location /docs/auth/swagger.json {
    proxy_pass http://auth_backend/swagger.json;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}
}

