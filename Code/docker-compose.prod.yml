version: '3.8'

services:
  msSeguridad:
    build: 
      context: ./msSeguridad
      dockerfile: Dockerfile
    image: msseguridad:latest
    container_name: ms-seguridad
    restart: unless-stopped
    expose:
      - "3002"
    environment:
      - MONGO_URI=mongodb://${MONGODB_USER}:${MONGODB_PASSWORD}@mongodb:27017/seguridad?authSource=admin
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRY=15m
      - REFRESH_TOKEN_EXPIRY_DAYS=7
      - PORT=3002
      - NODE_ENV=production
    depends_on:
      - mongodb
    networks:
      - applesales-network

  msClientes:
    build: ./msClientes
    image: msclientes:latest
    container_name: ms-clientes
    restart: unless-stopped
    expose:
      - "3003"
    environment:
      - MONGO_URL=mongodb://${MONGODB_USER}:${MONGODB_PASSWORD}@mongodb:27017/clientes?authSource=admin
      - PORT=3003
      - JWT_SECRET=${JWT_SECRET}
      - SEGURIDADMS_URL=http://ms-seguridad:3002/api/v1/
      - NODE_ENV=production
    depends_on:
      - mongodb
      - msSeguridad
    networks:
      - applesales-network

  msProductos:
    build: ./msProductos
    image: msproductos:latest
    container_name: ms-productos
    restart: unless-stopped
    expose:
      - "3001"
    environment:
      - MONGO_URL=mongodb://${MONGODB_USER}:${MONGODB_PASSWORD}@mongodb:27017/productos?authSource=admin
      - PORT=3001
      - JWT_SECRET=${JWT_SECRET}
      - NODE_ENV=production
    depends_on:
      - mongodb
    networks:
      - applesales-network

  mongodb:
    image: mongo:7
    container_name: mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGODB_USER}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGODB_PASSWORD}
    volumes:
      - mongodb-data:/data/db
    networks:
      - applesales-network
    command: mongod --auth

  nginx:
    image: nginx:alpine
    container_name: nginx-proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - /opt/applesales/docs:/usr/share/nginx/docs:ro
    depends_on:
      - msSeguridad
      - msClientes
      - msProductos
    networks:
      - applesales-network

networks:
  applesales-network:
    driver: bridge

volumes:
  mongodb-data:
    driver: local
